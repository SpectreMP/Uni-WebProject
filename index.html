<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Math warriors</title>
    <script src="node_modules/phaser/dist/phaser.min.js"></script>
    <style type="text/css">
        body{
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">
var PLAYER;
var DEBUG = false;

class GameScene extends Phaser.Scene{
    preload(){
        this.load.spritesheet('vagabond', 'src/vagabond.png', {frameWidth:64});
        this.load.spritesheet('mannequin', 'src/mannequin.png', {frameWidth:48})

        this.load.image('base', 'src/SampleMap/[Base]BaseChip_pipo.png')
        this.load.image('water', 'src/SampleMap/[A]Water_pipo.png')
        this.load.image('grass', 'src/SampleMap/[A]Grass_pipo.png')
        this.load.image('flower', 'src/SampleMap/[A]Flower_pipo.png')
        this.load.tilemapTiledJSON('samplemap', 'src/SampleMap/samplemap.json')
    }
    create(){
        const map = this.add.tilemap('samplemap' );

        const baseSet = map.addTilesetImage('[Base]BaseChip_pipo', 'base');
        const waterSet = map.addTilesetImage('[A]Water_pipo', 'water');
        const grassSet = map.addTilesetImage('[A]Grass_pipo', 'grass');
        const flowerSet = map.addTilesetImage('[A]Flower_pipo', 'flower');

        const groundLayer = map.createLayer('ground', [baseSet, waterSet, grassSet, flowerSet]);
        const grassLayer = map.createLayer('grass', [baseSet, waterSet, grassSet, flowerSet]);
        const waterLayer = map.createLayer('water', [baseSet, waterSet, grassSet, flowerSet]);
        const waterGrassLayer = map.createLayer('water_grass', [baseSet, waterSet, grassSet, flowerSet]);
        const buildingLayer = map.createLayer('building', [baseSet, waterSet, grassSet, flowerSet]);
        const farmLayer = map.createLayer('farm', [baseSet, waterSet, grassSet, flowerSet]);
        const farmUpLayer = map.createLayer('farm_up', [baseSet, waterSet, grassSet, flowerSet]);
        const collisionLayer = map.createLayer('collisions', DEBUG ? [baseSet] : []);
        const treeLayer = map.createLayer('tree', [baseSet, waterSet, grassSet, flowerSet]);
        const buildingUpLayer = map.createLayer('building_up', [baseSet, waterSet, grassSet, flowerSet]);

        this.creatures = this.physics.add.group();
        this.enemies = this.physics.add.group();
        this.allies = this.physics.add.group();

        const vagabond = new Creature({
            scene: this,
            x: 120,
            y: 120,
            texture: 'vagabond',
            health: 10,
            damage: 2,
            speed: 200,
            scale: 2,
            idleAnimation: 'vagabondIdle',
            moveAnimation: 'vagabondMove'
        });

        const mannequin = new Creature({
            scene: this,
            x: 320,
            y: 120,
            texture: 'mannequin',
            health: 10,
            damage: 2,
            speed: 200,
            scale: 3,
            idleAnimation: 'mannequinIdle',
            moveAnimation: 'mannequinMove'
        })
        
        const mannequin2 = new Creature({
            scene: this,
            x: 320,
            y: 320,
            texture: 'mannequin',
            health: 10,
            damage: 2,
            speed: 200,
            scale: 3,
            idleAnimation: 'mannequinIdle',
            moveAnimation: 'mannequinMove'
        })

        this.anims.create({
            key:'vagabondMove',
            frames:this.anims.generateFrameNumbers('vagabond', {start:0, end:7}),
            frameRate: 8
        });

        this.anims.create({
            key:'vagabondIdle',
            frames: [{key:'vagabond', frame:16}],
            frameRate: 8
        });

        this.anims.create({
            key:'mannequinMove',
            frames:this.anims.generateFrameNumbers('mannequin', {start:0, end:5}),
            frameRate: 8
        });
        
        this.anims.create({
            key:'mannequinIdle',
            frames:[{key: 'mannequin', frame: 6}],
            frameRate: 8
        });
        
        this.anims.create


        this.cursors = this.input.keyboard.createCursorKeys();

        PLAYER = vagabond;

        this.enemies.add(mannequin);
        this.enemies.add(mannequin2);

        collisionLayer.setCollision(294);
        this.physics.add.collider(this.creatures, collisionLayer);

        this.cameras.main.startFollow(PLAYER, true, 0.2, 0.2);

        console.log(this)
    }
    update(){

    }
}

class Creature extends Phaser.Physics.Arcade.Sprite{
    constructor(config){
        super(config.scene, config.x, config.y, config.texture);
        this.scene.add.existing(this);
        this.scene.physics.add.existing(this);
        this.scene.creatures.add(this);

        this.setScale(config.scale);
        this.setBodySize(5, 5)
        this.setOffset(this.width/2 - 5/2, this.height - 5/2)

        this.setData('health', config.health);
        this.setData('damage', config.damage);
        this.setData('speed', config.speed);
        this.setData('iframes', 0);
        this.setData('attackCooldown', 0);

        this.idleAnimation = config.idleAnimation;
        this.moveAnimation = config.moveAnimation;

        if (DEBUG){
            this.debugPositionPoint = this.scene.add.ellipse(this.body.center.x, this.body.center.y, this.scale*5, this.scale*5, 0xff0000)
        }
    };
    
    takeDamage(damage){
        if (this.data.values.iframes == 0){
            this.data.values.health -= damage;
            this.data.values.iframes = 10;
        };
        console.log('Осталось ', this.data.values.health)
    };

    attack(damage, delay, cooldown){
        if (this.data.values.attackCooldown == 0){
            let hitbox = this.scene.add.rectangle(this.body.center.x, this.body.center.y, 100, 100, 0x000000, 0.2);
            let hitboxBody = new Phaser.Physics.Arcade.StaticBody(this.scene.physics.world, hitbox);
            let hitboxCollider = this.scene.physics.add.collider(hitbox, this.scene.enemies, function(object1, object2){object2.takeDamage(damage)})
            hitbox.body = hitboxBody;

            this.scene.time.delayedCall(delay, function(){hitbox.destroy(); hitboxBody.destroy(); hitboxCollider.destroy();})
            
            this.data.values.attackCooldown = cooldown;
        }
    }

    progressEffects(){
        if (this.data.values.iframes > 0){
            this.data.values.iframes -= 1;
        };
        if (this.data.values.attackCooldown>0){
            this.data.values.attackCooldown -= 1;
        }
    };

    playerControl(input){

        let direction = new Phaser.Math.Vector2(0,0);

        if (input.left.isDown){
            direction.x = -1;
        }
        if (input.right.isDown){
            direction.x = 1;
        }
        if (input.up.isDown){
            direction.y = -1;
        }
        if (input.down.isDown){
            direction.y = 1;
        }
        if (input.space.isDown){
            this.attack(2, 100, 20);
        }
        
        direction.normalize();
        this.body.setVelocity(direction.x * this.data.values.speed, direction.y * this.data.values.speed);
    }
    
    preUpdate(delta, time){
        super.preUpdate(delta, time);
        if (this == PLAYER){
            this.playerControl(this.scene.cursors)
        } else {
            this.setVelocity(0);
        }

        if (this.body.velocity.x<0){
            this.flipX = true;
        }
        if (this.body.velocity.x>0){
            this.flipX = false;
        }
        if (this.body.velocity.length() == 0){
            this.anims.play(this.idleAnimation, true)
        } else {
            this.anims.play(this.moveAnimation, true);
        }

        this.progressEffects();
        if (DEBUG){
            this.debugPositionPoint.setPosition(this.body.center.x, this.body.center.y)
        }
    }
}
function setPlayer(target){
    PLAYER = target;
    target.scene.cameras.main.startFollow(target);
}

const config = {
    type: Phaser.AUTO,
    width: 1024,
    height: 768,
    physics: {
        default: 'arcade',
        arcade: {
            debug: false
        }
    },
    scene:GameScene
};

const game = new Phaser.Game(config);

</script>
    
</body>
</html>